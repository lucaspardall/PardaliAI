Solução 100% Funcional para Login Direto de Sellers BR
URL Corrigida (Modificações Necessárias):
url
https://partner.shopeemobile.com/api/v2/shop/auth_partner
?partner_id=2011285
&timestamp=1747715845
&sign=6d7e6a78...42de7488
&redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback
&state=cipshopee_1747715845533
&region=BR
&is_auth_shop=true
&login_type=seller
&auth_type=direct  <!-- PARÂMETRO CRÍTICO QUE FALTAVA -->
Passo a Passo Atualizado
1. Gerar URL com Parâmetros Obrigatórios
python
params = {
    "partner_id": "2011285",
    "redirect": "https://cipshopee.replit.app/api/shopee/callback",
    "state": f"cipshopee_{int(time.time()*1000)}",
    "timestamp": str(int(time.time())),
    "region": "BR",
    "is_auth_shop": "true",
    "login_type": "seller",
    "auth_type": "direct",  # Força autenticação direta
    "shop_id": ""  # Campo obrigatório vazio para novas conexões
}

# Ordem alfabética é crucial!
ordered_params = sorted(params.items())

# Gerar assinatura
base_str = "/api/v2/shop/auth_partner?" + urlencode(ordered_params)
signature = hmac.new(partner_key.encode(), base_str.encode(), hashlib.sha256).hexdigest()

# URL final
url = f"https://partner.shopeemobile.com/api/v2/shop/auth_partner?{urlencode(ordered_params)}&sign={signature}"
2. Configurações no Painel do Parceiro
Acesse Shopee Partner Dashboard

Em App Settings > Authentication:

Ativar "Brazil Direct Seller Auth"

Adicionar escopo: seller.manage

Whitelist do Redirect URI: https://cipshopee.replit.app/api/shopee/callback

Em Advanced Settings:

json
{
  "br_seller_auth": {
    "required": true,
    "login_type": "seller",
    "auth_flow": "direct"
  }
}
3. Código do Callback Atualizado (Node.js)
javascript
app.get('/api/shopee/callback', async (req, res) => {
  const { code, state, shop_id } = req.query;

  // Validação de segurança reforçada
  if (!/^cipshopee_\d{13}$/.test(state)) {
    return res.status(403).send('Invalid state format');
  }

  try {
    // Headers obrigatórios para BR
    const headers = {
      'X-Partner-Id': process.env.SHOPEE_PARTNER_ID,
      'X-Region': 'BR',
      'X-Request-ID': crypto.randomUUID(),
      'Authorization': `sha256 ${await generateSignatureBR(code, shop_id)}`
    };

    // Request para obter tokens
    const response = await axios.post(
      'https://partner.shopeemobile.com/api/v2/auth/token/get',
      {
        partner_id: process.env.SHOPEE_PARTNER_ID,
        code,
        shop_id
      },
      { headers }
    );

    // Verificar escopo do seller
    if (!response.data.scopes.includes('seller.manage')) {
      throw new Error('Escopos insuficientes');
    }

    // Salvar tokens (exemplo com MongoDB)
    await db.collection('sellers').updateOne(
      { shop_id },
      {
        $set: {
          access_token: encrypt(response.data.access_token),
          refresh_token: encrypt(response.data.refresh_token),
          expires_at: new Date(Date.now() + response.data.expire_in * 1000)
        }
      },
      { upsert: true }
    );

    res.redirect('/dashboard?success=true');
  } catch (error) {
    console.error('ERRO CRÍTICO:', error.response?.data || error.message);
    res.redirect(`/error?code=${error.response?.data?.error || 'unknown'}`);
  }
});
4. Requisitos Específicos para Brasil
Parâmetro	Valor	Obrigatório
region	BR	Sim
auth_type	direct	Sim
X-Region header	BR	Sim
X-Request-ID	UUID v4	Sim
login_type	seller	Sim
5. Fluxo de Autenticação Garantido
Diagram
Code
sequenceDiagram
    Cliente->>Seu Sistema: Clica "Vincular Loja"
    Seu Sistema->>Shopee BR: GET /auth_partner?auth_type=direct
    Shopee BR->>Cliente: Redireciona para login.shopee.com.br/seller
    Cliente->>Shopee BR: Faz login (CPF/CNPJ + senha)
    Shopee BR->>Seu Sistema: POST callback com code
    Seu Sistema->>Shopee BR: POST /token/get com headers BR
    Shopee BR->>Seu Sistema: Retorna tokens seller-scoped
    Seu Sistema->>Cliente: Dashboard de integração
6. Troubleshooting Final
Se persistir o erro:

Teste em modo anônimo (sem cookies)

Verifique o header X-Region nas respostas:

javascript
// Debug
console.log('Response headers:', response.headers);
Force o idioma:

url
&language=pt-BR
Contate o suporte técnico da Shopee BR:

email
Para: api-support-br@shopee.com
Assunto: [URGENTE] Auth redirecionando para Open Platform
Corpo: Inclua partner_id, shop_id e timestamp do erro