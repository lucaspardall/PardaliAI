rest-express@1.0.0 dev
2:48:52 PM [express] serving on port 5000s
Browserslist: browsers data (caniuse-lite) is 7 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
2:48:57 PM [express] GET /api/auth/user 200 in 43ms :: {"id":"41750934","email":"llouback4@gmail.com…
2:49:04 PM [express] GET /api/stores 304 in 95ms :: []
2:49:04 PM [express] GET /api/notifications 304 in 108ms :: []
======= INICIANDO FLUXO DE AUTORIZAÇÃO SHOPEE =======
Usuário autenticado: {
  claims: {
    aud: '73ee031f-24e8-4b77-96e8-2cd2724cf5f2',
    exp: 1747706032,
    iat: 1747702432,
    iss: 'https://replit.com/oidc',
    sub: '41750934',
    email: 'llouback4@gmail.com',
    at_hash: 'U-CaeNi2m0Blr4mqywMWDw',
    username: 'llouback4',
    auth_time: 1747702432,
    last_name: 'Louback',
    first_name: 'Lucas'
  },
  expires_at: 1747706032,
  access_token: '14uEKqq2lIejigtBcJw1rf1NvrcCDofm_Ce8V2FFEXQ',
  refresh_token: 'SyOH5cOtdrf8FLH-jyjjKv1JNFqPaSHMw7CHzsXud-e'
}
Ambiente: development
Informações de configuração da API:
Partner ID: 2011285
URL de redirecionamento configurada: undefined
===================================================
String base para assinatura: 2011285/api/v2/shop/auth_partner1747752552
URL final construída manualmente: https://seller.shopee.com.br/api/v2/shop/auth_partner?partner_id=2011285&timestamp=1747752552&sign=405024dfeb70b2f67cf0769023472a02695c8b98e1f454225bf35730ec6664d0&redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback&state=cipshopee_1747752552035&region=BR&is_auth_shop=true&login_type=seller&auth_type=direct&shop_id=
URL final para autorização: https://seller.shopee.com.br/api/v2/shop/auth_partner?partner_id=2011285&timestamp=1747752552&sign=405024dfeb70b2f67cf0769023472a02695c8b98e1f454225bf35730ec6664d0&redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback&state=cipshopee_1747752552035&region=BR&is_auth_shop=true&login_type=seller&auth_type=direct&shop_id=
Verificação de parâmetros críticos:
- region=BR: true
- login_type=seller: true
- auth_type=direct: true
- is_auth_shop=true: true
✅ URL salva em arquivo para inspeção: shopee_auth_url.txt
✅ Parâmetro auth_type=direct presente na URL
================================================
2:49:12 PM [express] GET /api/shopee/authorize 200 in 156msgerou isso. https://seller.shopee.com.br/api/v2/shop/auth_partner?partner_id=2011285×tamp=1747752552&sign=405024dfeb70b2f67cf0769023472a02695c8b98e1f454225bf35730ec6664d0&redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback&state=cipshopee_1747752552035®ion=BR&is_auth_shop=true&login_type=seller&auth_type=direct&shop_id=EditarInvestigated URL character encoding anomaly during Shopee authorization.9 sInteressante, nos logs do sistema vejo que a URL está sendo construída corretamente como:
URL final para autorização: https://seller.shopee.com.br/api/v2/shop/auth_partner?partner_id=2011285&timestamp=1747752552&sign=405024dfeb70b2f67cf0769023472a02695c8b98e1f454225bf35730ec6664d0&redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback&state=cipshopee_1747752552035&region=BR&is_auth_shop=true&login_type=seller&auth_type=direct&shop_id=
Porém, quando o redirecionamento acontece, a URL sofre uma transformação e o parâmetro "timestamp" vira "×tamp":
https://seller.shopee.com.br/api/v2/shop/auth_partner?partner_id=2011285×tamp=1747752552&sign=405024dfeb70b2f67cf0769023472a02695c8b98e1f454225bf35730ec6664d0...
Este é um problema clássico de codificação de caracteres onde o "i" em "timestamp" está sendo substituído pelo caractere "×".
Pelo que observei nos logs, a URL está correta no código, mas está sendo alterada em algum ponto do processo. Isso pode estar acontecendo:

Durante o redirecionamento do servidor para o navegador
Durante a renderização da página HTML (se os parâmetros são inseridos em um template)
Por algum middleware que esteja manipulando os URLs

Vamos analisar o código em shopee.ts onde o redirecionamento acontece para identificar o problema exato:
javascript// Em produção, redirecionamento direto
return res.redirect(authUrl);
Este trecho de código parece correto, mas pode ser que a URL esteja sendo manipulada incorretamente em outro lugar.
Verifico que em desenvolvimento, ele está enviando um HTML com a URL:
javascript// Em desenvolvimento, mostrar opções para o usuário
if (process.env.NODE_ENV === 'development') {
  return res.send(`
    <html>
      ...
      <pre>${authUrl}</pre>
      <a href="${authUrl}" class="btn primary">Ir para Autorização da Shopee</a>
      ...
    </html>
  `);
}
Aqui poderia estar o problema - quando a URL é inserida no HTML, a codificação de caracteres pode estar causando o problema.
Vamos propor algumas soluções para resolver este problema específico:Analisando os logs e a URL gerada, identifico que ainda está ocorrendo a substituição de "timestamp" por "×tamp" na URL final, mesmo que nos logs do servidor a URL pareça correta.
Causa Identificada
Esse problema é uma questão de codificação de caracteres que ocorre especificamente quando:

A URL é gerada corretamente no servidor (como vemos nos logs)
Mas ao ser renderizada no HTML ou durante o redirecionamento, o caractere "i" em "timestamp" está sendo substituído pelo caractere "×"

Solução
Já que estamos em ambiente de desenvolvimento, o problema provavelmente está ocorrendo quando a URL é incluída no HTML para o link da página. Vamos implementar uma solução que garanta a preservação dos parâmetros corretos.
1. Modifique o código em shopee.ts para codificar cada componente separadamente:
javascript// Em shopee.ts, na rota /authorize
if (process.env.NODE_ENV === 'development') {
  // Fixar manualmente o problema do caractere
  const safeAuthUrl = authUrl.replace('timestamp', 'timestamp'); // Força a recriação da string
  
  return res.send(`
    <html>
      <head>
        <title>Redirecionamento para Shopee</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
          .card { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
          .btn { display: inline-block; padding: 10px 16px; border-radius: 4px; text-decoration: none; margin: 10px 5px 10px 0; }
          .primary { background: #ff5722; color: white; }
          .secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
          pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
          .instructions { background: #fff8e1; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }
          .steps { list-style-type: decimal; padding-left: 20px; }
          .steps li { margin-bottom: 10px; }
        </style>
      </head>
      <body>
        <h1>Redirecionamento para Autenticação Shopee</h1>
        <div class="card">
          <h2>URL de Autorização</h2>
          <pre>${safeAuthUrl}</pre>
          
          <!-- SOLUÇÃO CRÍTICA: Construir o link de forma segura com componentes separados -->
          <a href="${authUrl.split('timestamp').join('timestamp')}" class="btn primary">Ir para Autorização da Shopee</a>
          
          <!-- Ou como alternativa, use parâmetros de URL encodados manualmente -->
          <form action="https://seller.shopee.com.br/api/v2/shop/auth_partner" method="get">
            <input type="hidden" name="partner_id" value="2011285">
            <input type="hidden" name="timestamp" value="1747752552">
            <input type="hidden" name="sign" value="${authUrl.match(/sign=([^&]*)/)[1]}">
            <input type="hidden" name="redirect" value="https://cipshopee.replit.app/api/shopee/callback">
            <input type="hidden" name="state" value="${authUrl.match(/state=([^&]*)/)[1]}">
            <input type="hidden" name="region" value="BR">
            <input type="hidden" name="is_auth_shop" value="true">
            <input type="hidden" name="login_type" value="seller">
            <input type="hidden" name="auth_type" value="direct">
            <input type="hidden" name="shop_id" value="">
            <button type="submit" class="btn primary">Ir para Autorização via Form</button>
          </form>
          
          <a href="/dashboard" class="btn secondary">Voltar para o Dashboard</a>
        </div>
      </body>
    </html>
  `);
}
2. Modificação Alternativa no código de geração da URL (em auth.ts):
typescript// Mudar a forma como a URL é construída em auth.ts
// Ao invés de usar URLSearchParams ou concatenar, use Fetch API URLSearchParams
const url = new URL(`${baseUrl}${basePathForShopAuthorize}`);
url.searchParams.append('partner_id', this.config.partnerId);
url.searchParams.append('timestamp', timestamp.toString());
url.searchParams.append('sign', signature);
url.searchParams.append('redirect', encodeURIComponent(this.config.redirectUrl));
// ... adicione os outros parâmetros da mesma forma
const urlString = url.toString();
3. Contornar o problema usando window.location.assign via JavaScript:
javascriptif (process.env.NODE_ENV === 'development') {
  // Construir URL com JavaScript para evitar problemas de codificação
  return res.send(`
    <html>
      <head>
        <title>Redirecionamento para Shopee</title>
        <!-- ... estilos ... -->
      </head>
      <body>
        <h1>Redirecionamento para Autenticação Shopee</h1>
        <div class="card">
          <h2>URL de Autorização</h2>
          <pre>${authUrl}</pre>
          
          <button id="redirectBtn" class="btn primary">Ir para Autorização da Shopee</button>
          <a href="/dashboard" class="btn secondary">Voltar para o Dashboard</a>
          
          <script>
            // Construir a URL via JavaScript - solução garantida
            document.getElementById('redirectBtn').addEventListener('click', function() {
              const url = new URL('https://seller.shopee.com.br/api/v2/shop/auth_partner');
              url.searchParams.append('partner_id', '2011285');
              url.searchParams.append('timestamp', '${timestamp}');
              url.searchParams.append('sign', '${signature}');
              url.searchParams.append('redirect', 'https://cipshopee.replit.app/api/shopee/callback');
              url.searchParams.append('state', 'cipshopee_${Date.now()}');
              url.searchParams.append('region', 'BR');
              url.searchParams.append('is_auth_shop', 'true');
              url.searchParams.append('login_type', 'seller');
              url.searchParams.append('auth_type', 'direct');
              url.searchParams.append('shop_id', '');
              
              window.location.href = url.toString();
            });
          </script>
        </div>
      </body>
    </html>
  `);
}
Solução para o ambiente de produção:
Se o problema persistir em produção, modifique o redirecionamento direto também:
javascript// Em produção, não usar res.redirect diretamente
const safeUrl = authUrl
  .replace(/timestamp/g, 'timestamp') // Forçar nova string para timestamp
  .replace(/×tamp/g, 'timestamp');    // Corrigir se já foi corrompido

return res.redirect(safeUrl);
Este problema é típico de uma corrupção de codificação de caracteres onde o caractere UTF-8 "i" em "timestamp" é interpretado incorretamente. As soluções acima devem garantir que a URL seja construída corretamente, independentemente de como o navegador ou o servidor estejam tratando a codificação.