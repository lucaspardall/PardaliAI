A URL está correta, mas falta um parâmetro crucial para forçar o login diretamente como seller/vendedor ao invés de usuário da Open Platform.

Solução Atualizada para Login Direto de Lojas BR
url
https://partner.shopeemobile.com/api/v2/shop/auth_partner?
  partner_id=2011285
  &timestamp=1747715514
  &sign=8f915b9c...f6ebb1f0
  &redirect=https%3A%2F%2Fcipshopee.replit.app%2Fapi%2Fshopee%2Fcallback
  &state=cipshopee_1747715514750
  &region=BR
  &is_auth_shop=true
  &login_type=seller  <!-- PARÂMETRO FALTANTE -->
Passo a Passo Corrigido
1. Geração da URL Correta (Atualizada)
python
params = {
    "partner_id": "2011285",
    "timestamp": str(int(time.time())),
    "redirect": "https://cipshopee.replit.app/api/shopee/callback",
    "state": f"cipshopee_{int(time.time()*1000)}",
    "region": "BR",
    "is_auth_shop": "true",
    "login_type": "seller"  # Novo parâmetro obrigatório
}

# Gerar assinatura com parâmetros ordenados
base_str = "/api/v2/shop/auth_partner?" + urlencode(sorted(params.items()))
signature = hmac.new(partner_key.encode(), base_str.encode(), hashlib.sha256).hexdigest()

url = f"https://partner.shopeemobile.com/api/v2/shop/auth_partner?{urlencode(params)}&sign={signature}"
2. Motivo do Redirecionamento Errado
Parâmetro Faltante	Impacto	Correção
login_type=seller	Shopee assume Open Platform	Adicionar à URL
Validação de Região	Header X-Region ausente	Configurar no callback
3. Implementação Garantida para Sellers BR
javascript
// Middleware para forçar região BR
app.use('/api/shopee/*', (req, res, next) => {
  req.headers['x-region'] = 'BR';
  next();
});

// Rota de callback atualizada
app.get('/api/shopee/callback', async (req, res) => {
  const { code, shop_id, state } = req.query;

  // Validação reforçada
  if (!/^cipshopee_\d+$/.test(state)) {
    return res.status(403).json({ error: "State inválido" });
  }

  try {
    // Obter tokens com headers regionais
    const response = await axios.post(
      'https://partner.shopeemobile.com/api/v2/auth/token/get',
      {
        partner_id: process.env.SHOPEE_PARTNER_ID,
        code,
        shop_id
      },
      {
        headers: {
          'Authorization': `sha256 ${gerarAssinatura(...)}`,
          'X-Partner-Id': process.env.SHOPEE_PARTNER_ID,
          'X-Region': 'BR'  // Header crítico
        }
      }
    );

    // Processamento seguro
    await processarTokens(response.data, shop_id);
    
    res.redirect('/dashboard?integracao=sucesso');
  } catch (error) {
    console.error('Falha crítica:', error.response.data);
    res.redirect(`/erro?codigo=shopee_${error.response?.data?.error || 'desconhecido'}`);
  }
});
4. Validações Adicionais Necessárias
No Painel do Parceiro:

Ativar "Modo Seller Direto" em App Settings > Authentication

Adicionar escopo shopee.seller.auth

No Código:

javascript
// Verificar permissões no token
const hasSellerAccess = (tokenData) => {
  return tokenData.scopes.includes('shopee.seller.manage');
};
5. Fluxo Corrigido
Diagram
Code
sequenceDiagram
    Cliente->>Sistema: Clica "Vincular Loja"
    Sistema->>Shopee BR: GET /auth_partner?login_type=seller
    Shopee BR->>Cliente: Tela de Login Seller (seller.shopee.com.br)
    Cliente->>Shopee BR: Insere CPF/CNPJ e senha
    Shopee BR->>Sistema: POST /callback com code
    Sistema->>Shopee BR: POST /token/get com headers regionais
    Shopee BR->>Sistema: Retorna tokens seller-scoped
    Sistema->>Cliente: Redireciona para dashboard
6. Troubleshooting Avançado
Problema	Diagnóstico	Solução
Loop de login	Cookie de sessão conflitante	Usar modo anônimo/inPrivate
Erro 1004	Parâmetros fora de ordem	Usar sorted(params.items())
Redirect para Open Platform	login_type ausente	Adicionar &login_type=seller
Token sem permissões	Escopos incorretos	Solicitar shopee.seller.manage
Documentação Oficial: